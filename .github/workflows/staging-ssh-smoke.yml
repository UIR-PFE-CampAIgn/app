name: Staging SSH Smoke Test
on:
    workflow_dispatch: {} # run manually from the Actions tab

jobs:
    ssh-smoke:
        runs-on: ubuntu-latest
        steps:
            - name: Print target (sanity)
              run: |
                  echo "Target host: ${{ secrets.STAGING_HOST }}"
                  echo "Target user: ${{ secrets.STAGING_USER }}"

            # Quick raw SSH check (helpful debug if the next step fails early)
            - name: Raw SSH hello (sanitize + prove)
              shell: bash
              env:
                  HOST_RAW: ${{ secrets.STAGING_HOST }} # pure IP, per you
                  USER_RAW: ${{ secrets.STAGING_USER }}
                  KEY_RAW: ${{ secrets.STAGING_SSH_KEY }}
              run: |
                  set -euo pipefail

                  # 1) Strip CR, trailing/leading whitespace, and zero-width chars from HOST/USER
                  strip_zw() { perl -CSDA -pe 's/\x{200B}|\x{200C}|\x{200D}|\x{FEFF}//g'; }
                  HOST="$(printf '%s' "$HOST_RAW" | tr -d '\r' | sed -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//' | strip_zw)"
                  USER="$(printf '%s' "$USER_RAW" | tr -d '\r' | sed -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//' | strip_zw)"

                  # 2) Show lengths and byte dump (safe: we don't print the value itself)
                  echo "HOST length: ${#HOST}"
                  echo "USER length: ${#USER}"
                  printf '%s' "$HOST" | od -An -t x1 | tr -s ' ' | sed 's/^/HOST bytes: /'
                  # Expect only hex bytes for digits and dots (30-39 for 0-9, 2e for .)

                  # 3) Validate shape: IPv4 (digits and dots only)
                  if [[ ! "$HOST" =~ ^[0-9.]+$ ]]; then
                  echo "STAGING_HOST contains unexpected characters; ensure it's only digits and dots."; exit 1
                  fi

                  # 4) Optional: ensure DNS isn’t used at all by passing an IP; ssh won't do DNS then.
                  mkdir -p ~/.ssh
                  printf '%s\n' "$KEY_RAW" > ~/.ssh/id_staging
                  chmod 600 ~/.ssh/id_staging

                  ssh -vvv -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_staging "$USER@$HOST" 'echo "SSH OK: $(uname -a)"'

            # Use the SSH action for a few deeper checks
            - name: Deep checks (docker/caddy/opt path)
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.STAGING_HOST }}
                  username: ${{ secrets.STAGING_USER }}
                  key: ${{ secrets.STAGING_SSH_KEY }}
                  script_stop: true
                  command_timeout: 30m
                  script: |
                      set -euo pipefail

                      echo "[whoami]"; whoami
                      echo "[hostname]"; hostname

                      echo "[docker version]"; docker --version
                      echo "[docker compose version]"; docker compose version || true
                      echo "[docker service status]"
                      if command -v systemctl >/dev/null 2>&1; then
                        systemctl is-active docker
                      else
                        echo "systemd not available (OK on some distros)"
                      fi

                      echo "[caddy version]"; caddy version || true
                      echo "[caddy service status]"
                      if command -v systemctl >/dev/null 2>&1; then
                        systemctl is-active caddy
                      fi

                      echo "[/opt layout]"
                      ls -la /opt/campaign-staging || (echo "/opt missing — deploy-opt.yml probably not run" && exit 1)
                      ls -la /opt/campaign-staging/stack

                      echo "[compose ps]"
                      cd /opt/campaign-staging/stack
                      docker compose ps || true

                      echo "[health scripts]"
                      if [[ -f healthcheck.sh ]]; then
                        echo "Running local health check samples (may fail if envs/images not yet set)"
                        bash healthcheck.sh web || true
                        bash healthcheck.sh gateway || true
                        bash healthcheck.sh ml || true
                      else
                        echo "healthcheck.sh not found (OK if not deployed yet)"
                      fi

                      echo "✅ SSH smoke checks completed"
