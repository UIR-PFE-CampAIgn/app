name: "Staging (develop): Web"

on:
    push:
        branches: [develop]

env:
    REGISTRY: ghcr.io
    ORG: UIR-PFE-CampAIgn
    SONAR_HOST_URL: https://sonarcloud.io

concurrency:
    group: staging-${{ github.repository }}
    cancel-in-progress: true

jobs:
    test_and_sonar:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with: { node-version: "20" }

            - uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

            - name: Install
              run: |
                  npm ci

            - name: Debug Sonar secrets
              run: |
                  set -e
                  for var in SONAR_PROJECT_KEY SONAR_ORG SONAR_TOKEN; do
                      value="${!var:-}"
                      echo "$var length: ${#value}"
                  done
              env:
                  SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
                  SONAR_ORG: ${{ secrets.SONAR_ORG }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

            - name: SonarCloud Scan
              uses: SonarSource/sonarcloud-github-action@v2
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              with:
                  args: >
                      -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
                      -Dsonar.organization=${{ secrets.SONAR_ORG }}
                      -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
                      -Dsonar.qualitygate.wait=true

    build_and_deploy:
        needs: test_and_sonar
        runs-on: ubuntu-latest
        permissions: { contents: read, packages: write }
        steps:
            - uses: actions/checkout@v4
            - uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Compute image tags
              id: vars
              run: |
                  REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
                  echo "image=ghcr.io/${REPO_LOWER}" >> $GITHUB_OUTPUT
                  echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

            - name: Build & Push
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ steps.vars.outputs.image }}:develop
                      ${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.sha_short }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Deploy web (targeted)
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.STAGING_HOST }}
                  username: ${{ secrets.STAGING_USER }}
                  key: ${{ secrets.STAGING_SSH_KEY }}
                  script_stop: true
                  command_timeout: 30m
                  script: |
                      set -e
                      cd /opt/campaign-staging/stack
                      echo "WEB_TAG=${{ steps.vars.outputs.sha_short }}" | sudo tee .deploy_tags >/dev/null
                      ./deploy.sh web
